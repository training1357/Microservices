============  Docker Compose =============

- The multi container tool

01. Melihat contoh file YAML
	- template.yml
	- docker-compose-1.yml
	- docker-compose-2.yml
	- docker-compose-3.yml

02. Install docker compose

	$ sudo apt install docker-compose
		Building dependency tree
		Reading state information... Done
		E: Unable to locate package docker-compose
		
	Jika ada pesan Error spt diatas, enable semua software update yg ada
	di setting Ubuntu
	
	$ sudo apt install docker-compose
	
	$ docker-compose version
		docker-compose version 1.25.0, build unknown
		docker-py version: 4.1.0
		CPython version: 3.8.2
		OpenSSL version: OpenSSL 1.1.1f  31 Mar 2020

03. Persiapan.
	- Yakinkan tidak ada container yg running
	- Hapus semua container yg ada
	- Buat direktory
	
		$ mkdir /home/docker1/labs/compose1
		$ cd /home/docker1/labs/compose1
		
04. Buat file YAML

	$ cd /home/docker1/labs/compose1
	$ nano docker-compose.yml

		version: '3'

		services:
		  proxy:
			image: nginx:1.13     # versi yg digunakan 1.13
			ports:
			- '80:80'
			volumes:
			- ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
		  web:
			image: httpd
	
05. Copy nginx.conf ke /home/docker1/labs/compose1

06. Startup Docker Compose

	$ cd /home/docker1/labs/compose1
	$ docker-compose up
	
07. Verifikasi

	$ docker container ls
	
		CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS         PORTS                               NAMES
		a52e99457ae4   nginx:1.13   "nginx -g 'daemon of…"   4 minutes ago   Up 4 minutes   0.0.0.0:80->80/tcp, :::80->80/tcp   compose1_proxy_1
		502f1b056fec   httpd        "httpd-foreground"       4 minutes ago   Up 4 minutes   80/tcp                              compose1_web_1
	
	$ curl http://localhost
	
		<html><body><h1>It works!</h1></body></html>

08. Mematikan container

	Tekan CTRL-C 

		Stopping compose1_proxy_1 ... done
		Stopping compose1_web_1   ... done
	
	$ docker container ls -a
	
		CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS                      PORTS     NAMES
		a52e99457ae4   nginx:1.13   "nginx -g 'daemon of…"   9 minutes ago   Exited (0) 24 seconds ago             compose1_proxy_1
		502f1b056fec   httpd        "httpd-foreground"       9 minutes ago   Exited (0) 23 seconds ago             compose1_web_1
	
09. Beberapa perintah lain di Docker Compose:

	$ docker-compose up -d    ==> Menghidupkan secara background

		Starting compose1_web_1   ... done
		Starting compose1_proxy_1 ... done

	$ docker-compose logs    ==> Melihat isi file logs
	
	# Melihat process running	
	$ docker-compose ps
	$ docker-compose top

	# Shutdown
	$ docker-compose down
	
		Stopping compose1_proxy_1 ... done
		Stopping compose1_web_1   ... done
		Removing compose1_proxy_1 ... done
		Removing compose1_web_1   ... done
		Removing network compose1_default

	$ docker container ls -a

==== Drupal CMS ===

01. Preparations:
	- Pelajari dokumentasi untuk Drupal + Postgresql
	- pergi ke hub.docker.com : cari info Drupal + Postgresql
	
02. - Yakinkan tidak ada container 
	- Yakinkan tidak ada volume

	$ docker container ls -a
	$ docker container rm -f <container-name>
	$ docker volume ls
	$ docker volume prune

03. Download image yg diperlukan

	$ docker pull drupal:8.8.2
	$ docker pull postgres:12.1
	$ docker image ls

		drupal      8.8.2     090e3f252532   19 months ago   454MB
		postgres    12.1      cf879a45faaa   19 months ago   394MB

04. Buat directory

	$ mkdir /home/docker1/labs/compose2
	$ cd /home/docker1/labs/compose2
	
05. Buat file /home/docker1/labs/compose2/docker-compose.yml

	$ cd /home/docker1/labs/compose2
	$ nano docker-compose.yml

		version: '3'

		services:
		   drupal:
			  image: drupal:8.8.2
			  ports:
			  - "8080:80"
			  volumes:
			  - drupal-modules:/var/www/html/modules
			  - drupal-profiles:/var/www/html/profiles
			  - drupal-sites:/var/www/html/sites
			  - drupal-themes:/var/www/html/themes
		   postgress:
			  image: postgres:12.1
			  environment:
			  - POSTGRES_PASSWORD=mypasswd

		volumes:
		   drupal-modules:
		   drupal-profiles:
		   drupal-sites:
		   drupal-themes:


06. Startup

	$ cd /home/docker1/labs/compose2
	$ docker-compose up -d

07. Verify

	$ docker container ls -a

		CONTAINER ID   IMAGE           COMMAND                  CREATED              STATUS              PORTS                                   NAMES
		bbf97a0f0040   postgres:12.1   "docker-entrypoint.s…"   About a minute ago   Up About a minute   5432/tcp                                compose2_postgress_1
		ad85fe6d70d8   drupal:8.8.2    "docker-php-entrypoi…"   About a minute ago   Up About a minute   0.0.0.0:8080->80/tcp, :::8080->80/tcp   compose2_drupal_1

	$ docker volume ls

		DRIVER    VOLUME NAME
		local     6e882085d2a1a24811cacb39b2eebc5c8e123b2d3d980bb379f1132babdce26d
		local     compose2_drupal-modules
		local     compose2_drupal-profiles
		local     compose2_drupal-sites
		local     compose2_drupal-themes

08. Test

	Buka Web Browser : http://192.168.182.135:8080

	Configure:
	- Language : English
	- Profile  : Standard
	- Database Type : PostgreSQL
		DB Name   : postgres
		DB user   : postgres
		DB Passwd : mypasswd
		Host      : postgress
	
09. Docker Compose Shutdown

	$ docker-compose down --help
	$ docker-compose down -v
	
		Stopping compose2_drupal_1    ... done
		Stopping compose2_postgress_1 ... done
		Removing compose2_drupal_1    ... done
		Removing compose2_postgress_1 ... done
		Removing network compose2_default
		Removing volume compose2_drupal-modules
		Removing volume compose2_drupal-profiles
		Removing volume compose2_drupal-sites
		Removing volume compose2_drupal-themes
	
	$ docker container ls -a	==> KOSONG
	$ docker volume ls			==> KOSONG
	
=== Adding Image Building to Compose Files ===

01. - Yakinkan tidak ada container 
	- Yakinkan tidak ada volume

	$ docker container ls -a
	$ docker container rm -f <container-name>
	$ docker volume ls
	$ docker volume prune

02. Kita akan membuat image : nginx-custom
	Yakinkan di lokal tidak ada image dg nama tsb
	
	$ docker image ls
	$ docker rmi nginx-custom

03. Buat directory

	$ mkdir /home/docker1/labs/compose3
	$ cd /home/docker1/labs/compose3
	
04. Copy semua files yg ada di compose-sample-2 
	ke /home/docker1/labs/compose3

05. - Buat custom image
	- Buat file nginx.Dockerfile
	
	$ cd /home/docker1/labs/compose3
	$ nano nginx.Dockerfile
	
		FROM nginx:1.13
		COPY nginx.conf /etc/nginx/conf.d/default.conf

06. Buat file /home/docker1/labs/compose3/docker-compose.yml

	$ cd /home/docker1/labs/compose3
	$ nano docker-compose.yml

		version: '3'

		services:
		   proxy:
			  build:
				 context: .
				 dockerfile: nginx.Dockerfile
			  image: nginx-custom
			  ports:
			  - '80:80'
		   web:
			 image: httpd
			 volumes:
			 - ./html:/usr/local/apache2/htdocs/

07. Startup

	$ cd /home/docker1/labs/compose3
	$ docker-compose up -d

		Creating network "compose3_default" with the default driver
		Building proxy
		Step 1/2 : FROM nginx:1.13
		 ---> ae513a47849c
		Step 2/2 : COPY nginx.conf /etc/nginx/conf.d/default.conf
		 ---> 15a629186e7f
		Successfully built 15a629186e7f
		Successfully tagged nginx-custom:latest
		WARNING: Image for service proxy was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.
		Creating compose3_proxy_1 ... done
		Creating compose3_web_1   ... done

	$ docker-compose logs
	$ docker container ls
	$ docker image ls

08. Testing

	Buka Web Browser : http://192.168.182.135
	
09. Shutdown Container

	$ docker-compose down -v
	$ docker container ls -a
	$ docker volume ls
	
10. Startup yg kedua kalinya

	$ cd /home/docker1/labs/compose3
	$ docker-compose up -d	

		Creating network "compose3_default" with the default driver
		Creating compose3_proxy_1 ... done
		Creating compose3_web_1   ... done

10. Shutdown Container

	$ docker-compose down -v
	$ docker container ls -a
	$ docker volume ls
	$ docker volume prune
	
====== Docker Swarm ======

01. - Yakinkan tidak ada container 
	- Yakinkan tidak ada volume

	$ docker container ls -a
	$ docker container rm -f <container-name>
	$ docker volume ls
	$ docker volume prune

02. Check Swarm

	$ docker info

		...
		Swarm: inactive
		...
		
03. Enable Swarm

	$ docker swarm init
	
		Swarm initialized: current node (iivwh8t2pqusu6weqok8wj3yw) is now a manager.

		To add a worker to this swarm, run the following command:

			docker swarm join --token SWMTKN-1-3hm28pb2tm58t5j2kt5zknp88hhwalr1d8zlg6xvk2sjg2ammb-1karwbe4jlavl9pe5m62b60hz 192.168.182.135:2377

		To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
	
	$ docker info

		Swarm: active
		  NodeID: iivwh8t2pqusu6weqok8wj3yw
		  Is Manager: true
		  ClusterID: zlvwegxem6j9a7j2qjhyhybry
		  Managers: 1
		  Nodes: 1
		  Default Address Pool: 10.0.0.0/8
		  SubnetSize: 24
		  Data Path Port: 4789
		  Orchestration:
		   Task History Retention Limit: 5
		  Raft:
		   Snapshot Interval: 10000
		   Number of Old Snapshots to Retain: 0
		   Heartbeat Tick: 1
		   Election Tick: 10
		  Dispatcher:
		   Heartbeat Period: 5 seconds
		  CA Configuration:
		   Expiry Duration: 3 months
		   Force Rotate: 0
		  Autolock Managers: false
		  Root Rotation In Progress: false
		  Node Address: 192.168.182.135
		  Manager Addresses:
		   192.168.182.135:2377

04. Swarm Command

	$ docker node ls
	
		ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION
		iivwh8t2pqusu6weqok8wj3yw *   vm1        Ready     Active         Leader           20.10.8

	$ docker node --help
	$ docker swarm --help
	
05. Swarm Leave

	$ docker swarm leave
	
		Error response from daemon: You are attempting to leave the swarm on a node that is participating as a manager. Removing the last manager erases all current state of the swarm. Use `--force` to ignore this message.	
	
	$ docker swarm leave --force
	$ docker info
	
	-- Create cluster lagi
	
	$ docker swarm init
	
		Swarm initialized: current node (ieh86y3ls9ae2mjgdc5hk7fto) is now a manager.

		To add a worker to this swarm, run the following command:

			docker swarm join --token SWMTKN-1-0jlpjhzwuuxnwleqfdnouwb7j6aox3kzhmuozes5tt0tnxv3d7-f2uaio8wx7dv26gkorsnlirwx 192.168.182.135:2377

		To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
	
==== Create Services ===

01. Create first service

	$ docker service ls
	
		ID        NAME      MODE      REPLICAS   IMAGE     PORTS
	
	$ docker service create alpine ping 8.8.8.8
	
		ekdn7fzg5blex225g7fycx49v
		overall progress: 1 out of 1 tasks
		1/1: running   [==================================================>]
		verify: Service converged
	
	$ docker service ls
	
		ID             NAME          MODE         REPLICAS   IMAGE           PORTS
		ekdn7fzg5ble   zen_lalande   replicated   1/1        alpine:latest
	
	$ docker service ps zen_lalande
	
		ID             NAME            IMAGE           NODE      DESIRED STATE   CURRENT STATE           ERROR     PORTS
		zscer8qvwo77   zen_lalande.1   alpine:latest   vm1       Running         Running 2 minutes ago
	
	$ docker container ls
	
		CONTAINER ID   IMAGE           COMMAND          CREATED         STATUS         PORTS     NAMES
		435abc4c0abe   alpine:latest   "ping 8.8.8.8"   6 minutes ago   Up 6 minutes             zen_lalande.1.zscer8qvwo77yzdvcj9u8f97f
	
02. Scale Up Service	
	- semula 1 replica kita ubah jadi 3 replica
	
	$ docker service update zen_lalande --replicas 3

		zen_lalande
		overall progress: 3 out of 3 tasks
		1/3: running   [==================================================>]
		2/3: running   [==================================================>]
		3/3: running   [==================================================>]
		verify: Service converged
	
	$ docker service ls
	
		ID             NAME          MODE         REPLICAS   IMAGE           PORTS
		ekdn7fzg5ble   zen_lalande   replicated   3/3        alpine:latest
		
	$ docker service ps zen_lalande
	
		ID             NAME            IMAGE           NODE      DESIRED STATE   CURRENT STATE                ERROR     PORTS
		zscer8qvwo77   zen_lalande.1   alpine:latest   vm1       Running         Running 12 minutes ago
		b7twzrj0tpsn   zen_lalande.2   alpine:latest   vm1       Running         Running about a minute ago
		uwukpq4o9hk4   zen_lalande.3   alpine:latest   vm1       Running         Running about a minute ago
			
	$ docker container ls
	
		CONTAINER ID   IMAGE           COMMAND          CREATED          STATUS          PORTS     NAMES
		184a8e2aed79   alpine:latest   "ping 8.8.8.8"   7 minutes ago    Up 7 minutes              zen_lalande.3.uwukpq4o9hk4m9980qkzecuct
		694a1ea4822d   alpine:latest   "ping 8.8.8.8"   7 minutes ago    Up 7 minutes              zen_lalande.2.b7twzrj0tpsnqnvj4x3x55ou5
		435abc4c0abe   alpine:latest   "ping 8.8.8.8"   17 minutes ago   Up 17 minutes             zen_lalande.1.zscer8qvwo77yzdvcj9u8f97f
			
03. Simulasi kerusakan

	$ docker service ls
	$ docker container rm -f zen_lalande.2.b7twzrj0tpsnqnvj4x3x55ou5
	$ docker service ls
	
		ID             NAME          MODE         REPLICAS   IMAGE           PORTS
		ekdn7fzg5ble   zen_lalande   replicated   2/3        alpine:latest
	
	Ulangi beberapa saat
	
	$ docker service ls
	
		ID             NAME          MODE         REPLICAS   IMAGE           PORTS
		ekdn7fzg5ble   zen_lalande   replicated   3/3        alpine:latest
	
	$ docker service ps zen_lalande
	
		ID             NAME                IMAGE           NODE      DESIRED STATE   CURRENT STATE                ERROR                         PORTS
		zscer8qvwo77   zen_lalande.1       alpine:latest   vm1       Running         Running 24 minutes ago
		j9m3mh6vzubo   zen_lalande.2       alpine:latest   vm1       Running         Running about a minute ago
		b7twzrj0tpsn    \_ zen_lalande.2   alpine:latest   vm1       Shutdown        Failed about a minute ago    "task: non-zero exit (137)"
		uwukpq4o9hk4   zen_lalande.3       alpine:latest   vm1       Running         Running 13 minutes ago

04. Remove Service

	$ docker service ls
	$ docker service rm zen_lalande
	$ docker container ls

==== Drupal CMS on Docker Swarm ====

01. Prerequisite-nya:
	Docker Swarm : Active
	Yakinkan tidak ada services

02. Create Overlay Networking

	# default network yg ada
	$ docker network ls

		NETWORK ID     NAME              DRIVER    SCOPE
		0a32cdd79efb   bridge            bridge    local
		51a91449afb4   docker_gwbridge   bridge    local
		1f68ad61a879   host              host      local
		d9a0w17d1abs   ingress           overlay   swarm
		f1830a1b0903   none              null      local

	$ docker network create --driver overlay mydrupal
	$ docker network ls

03. Create service PostgreSQL

	$ docker service create --name psql --network mydrupal -e POSTGRES_PASSWORD=mypass postgres
	$ docker service ls
	$ docker container ls
	$ docker container logs psql.1.fjn2m45ezb5skno6y566koavz

04. Create service Drupal CMS

	$ docker service create --name drupal --network mydrupal -p 80:80 drupal
	$ docker service ls
	$ docker container ls
	$ docker container logs drupal.1.k5m1cftk3vjtsqz798lo0h7ja

05. Testing 

	Buka Web Browser : http://192.168.182.135

	Configure:
	- Language : English
	- Profile  : Standard
	- Database Type : PostgreSQL
		DB Name   : postgres
		DB user   : postgres
		DB Passwd : mypass
		Host      : psql  ==> NAMA SERVICE

06. Scale Up Service

	$ docker service update psql --replicas 3
	$ docker service update drupal --replicas 2
	$ docker service ls
	
07. Scale Down Service

	$ docker service update psql --replicas 2
	$ docker service update drupal --replicas 1
	$ docker service ls	
	
08. Cleansing

	$ docker service ls
	$ docker service rm drupal
	$ docker service rm psql
	$ docker service ls
	
	$ docker network ls
	$ docker network rm mydrupal
	$ docker network ls
	
	$ docker volume ls  ==> LANGSUNG DIHAPUS VOLUME YG DIGUNAKAN SEBELUMNYA
	
	
	
	
	